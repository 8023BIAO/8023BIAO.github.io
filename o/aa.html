<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aetherion Architect V7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --glow: #6a4cff;
            --bg: #0a0a12;
            --text: #e0e0ff;
            --glass: rgba(20, 20, 35, .75);
            --safe: #00e676;
            --warn: #ffea00;
            --danger: #ff1744;
            --epic: #9c27b0;
            --legendary: #ffd700
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 20% 30%, rgba(40, 10, 60, .15)0%, transparent 40%), radial-gradient(circle at 80% 70%, rgba(10, 30, 60, .1)0%, transparent 40%)
        }

        #particles {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: .6;
            pointer-events: none
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px
        }

        header {
            padding: 4rem 0 2rem;
            text-align: center
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: .1em;
            text-shadow: 0 0 20px rgba(106, 76, 255, .6)
        }

        .subtitle {
            color: #b0b0ff;
            font-size: 1rem;
            letter-spacing: .15em;
            margin-top: .5rem
        }

        .quote {
            max-width: 700px;
            margin: 1.5rem auto;
            padding: 1rem;
            border-left: 3px solid var(--glow);
            background: linear-gradient(90deg, rgba(106, 76, 255, .1), transparent);
            font-style: italic;
            color: #aaa
        }

        .card {
            background: var(--glass);
            border: 1px solid rgba(106, 76, 255, .3);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            transition: .3s
        }

        .card:hover {
            border-color: var(--glow);
            box-shadow: 0 0 20px rgba(106, 76, 255, .2)
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            margin: 2rem 0
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr))
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))
        }

        @media(min-width:768px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr)
            }
            .grid-3 {
                grid-template-columns: repeat(3, 1fr)
            }
        }

        @media(min-width:1200px) {
            .grid-4 {
                grid-template-columns: repeat(4, 1fr)
            }
        }

        label {
            display: block;
            color: #8888aa;
            font-size: .75rem;
            text-transform: uppercase;
            margin-bottom: .3rem;
            letter-spacing: 1px
        }

        input,
        select {
            width: 100%;
            background: rgba(0, 0, 0, .4);
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Share Tech Mono';
            margin-bottom: 1rem;
            outline: none
        }

        input:focus,
        select:focus {
            border-color: var(--glow);
            box-shadow: 0 0 10px rgba(106, 76, 255, .3)
        }

        .result {
            background: rgba(0, 0, 0, .6);
            border-left: 4px solid #555;
            padding: 1rem;
            margin-top: 1rem
        }

        .result-safe {
            border-left-color: var(--safe)
        }

        .result-safe .val {
            color: var(--safe)
        }

        .result-warn {
            border-left-color: var(--warn)
        }

        .result-warn .val {
            color: var(--warn)
        }

        .result-danger {
            border-left-color: var(--danger);
            box-shadow: 0 0 15px rgba(255, 23, 68, .2)
        }

        .result-danger .val {
            color: var(--danger)
        }

        .result-epic {
            border-left-color: var(--epic);
            box-shadow: 0 0 15px rgba(156, 39, 176, .2)
        }

        .result-epic .val {
            color: #ce93d8
        }

        .result-legendary {
            border-left-color: var(--legendary);
            box-shadow: 0 0 15px rgba(255, 215, 0, .2)
        }

        .result-legendary .val {
            color: var(--legendary)
        }

        .val {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Orbitron'
        }

        .desc {
            font-size: .8rem;
            color: #aaa;
            margin-top: .3rem
        }

        .terminal {
            background: rgba(10, 8, 15, .95);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: .85rem;
            color: #a0a0ff;
            scrollbar-width: thin;
            scrollbar-color: var(--glow)#1a1a1a
        }

        .terminal::-webkit-scrollbar {
            width: 6px
        }

        .terminal::-webkit-scrollbar-track {
            background: #1a1a1a
        }

        .terminal::-webkit-scrollbar-thumb {
            background: var(--glow);
            border-radius: 3px
        }

        .btn {
            background: transparent;
            border: 1px solid var(--glow);
            color: var(--glow);
            padding: 8px 16px;
            font-family: 'Share Tech Mono';
            cursor: pointer;
            transition: .3s;
            text-transform: uppercase;
            font-size: .85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px
        }

        .btn:hover {
            background: var(--glow);
            color: #fff;
            box-shadow: 0 0 15px var(--glow)
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .flowchart {
            background: rgba(0, 0, 0, .3);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto
        }

        footer {
            text-align: center;
            padding: 3rem 0;
            color: #666;
            font-size: .9rem
        }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--glow);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px var(--glow)
        }

        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #444;
            border-radius: 2px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: .85rem
        }

        th,
        td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #333
        }

        th {
            color: var(--glow);
            font-weight: normal;
            text-transform: uppercase;
            font-size: .75rem
        }

        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 0
        }

        .flow-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            margin: 2px 0;
            background: rgba(0, 0, 0, .3);
            border-radius: 6px;
            border-left: 3px solid #555;
            transition: .2s
        }

        .flow-row:hover {
            background: rgba(106, 76, 255, .1);
            border-left-color: var(--glow)
        }

        .flow-arrow {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            padding: 4px 0
        }

        .flow-input {
            border-left-color: #6a4cff;
            background: rgba(106, 76, 255, .1)
        }

        .flow-calc {
            border-left-color: #ffea00;
            background: rgba(255, 234, 0, .05)
        }

        .flow-branch {
            border-left-color: #ff9800;
            background: rgba(255, 152, 0, .05)
        }

        .flow-danger {
            border-left-color: #ff1744;
            background: rgba(255, 23, 68, .1)
        }

        .flow-safe {
            border-left-color: #00e676;
            background: rgba(0, 230, 118, .1)
        }

        .flow-label {
            font-family: 'Orbitron', sans-serif;
            font-size: .9rem;
            color: #fff;
            min-width: 100px
        }

        .flow-desc {
            color: #aaa;
            font-size: .85rem;
            flex: 1
        }

        .flow-val {
            font-family: 'Share Tech Mono';
            color: var(--glow);
            font-size: .9rem
        }

        /* Monster card styles */
        .monster-card {
            background: rgba(0, 0, 0, .4);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: .2s;
        }

        .monster-card:hover {
            border-color: var(--glow);
            background: rgba(106, 76, 255, .05);
        }

        .monster-name {
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .monster-tag {
            display: inline-block;
            background: rgba(106, 76, 255, .2);
            color: #b0b0ff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .monster-tag.danger {
            background: rgba(255, 23, 68, .2);
            color: #ff8a80;
        }

        .monster-tag.safe {
            background: rgba(0, 230, 118, .2);
            color: #69f0ae;
        }

        /* Equipment quality colors */
        .quality-poor { color: #9e9e9e; }
        .quality-common { color: #fff; }
        .quality-uncommon { color: #00e676; }
        .quality-rare { color: #448aff; }
        .quality-epic { color: #ce93d8; }
        .quality-legendary { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, .5); }

        /* Weather indicator */
        .weather-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .weather-sunny { background: rgba(255, 193, 7, .2); color: #ffd54f; }
        .weather-rain { background: rgba(33, 150, 243, .2); color: #64b5f6; }
        .weather-storm { background: rgba(156, 39, 176, .2); color: #ce93d8; }
        .weather-fog { background: rgba(96, 125, 139, .2); color: #b0bec5; }
        .weather-marea { background: rgba(244, 67, 54, .2); color: #ef9a9a; }

        /* Faction reputation */
        .rep-hostile { color: #ff1744; }
        .rep-unfriendly { color: #ff9800; }
        .rep-neutral { color: #9e9e9e; }
        .rep-friendly { color: #00e676; }
        .rep-honored { color: #ffd700; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(106, 76, 255, .3);
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-family: 'Share Tech Mono';
            font-size: 0.85rem;
            white-space: nowrap;
            transition: .2s;
        }

        .tab:hover {
            color: #fff;
        }

        .tab.active {
            color: var(--glow);
            border-bottom: 2px solid var(--glow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media(max-width:768px) {
            .flow-row {
                flex-wrap: wrap;
                gap: 6px
            }

            .flow-label {
                width: 100%;
                min-width: auto
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--glass);
            border: 1px solid var(--glow);
            border-radius: 50%;
            color: var(--glow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: .3s;
            z-index: 100;
        }

        .scroll-top.visible {
            opacity: 1;
        }

        .scroll-top:hover {
            background: var(--glow);
            color: #fff;
        }
    </style>
</head>

<body>
    <div id="particles"></div>
    <div class="container">
        <header>
            <h1>AETHERION</h1>
            <div class="subtitle">裂隙纪元 301 · 熵增物理引擎</div>
            <div class="quote">"欢迎来到没有救赎但允许抗争的世界。死亡是计算结果，非剧情杀"</div>
        </header>

        <!-- 核心法则 -->
        <div class="card" style="margin:3rem 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;border-bottom:1px solid rgba(106,76,255,.3);padding-bottom:1rem;flex-wrap:wrap;gap:10px">
                <h2 class="section-title" style="margin:0"><i class="fas fa-scroll"></i> 核心法则协议 V7</h2>
                <div class="btn-group">
                    <button class="btn" onclick="App.copy()"><i class="fas fa-copy"></i> 复制</button>
                    <button class="btn" onclick="App.download()"><i class="fas fa-download"></i> 下载</button>
                    <button class="btn" onclick="App.toggleRules()"><i class="fas fa-eye"></i> 显示/隐藏</button>
                </div>
            </div>
            <div class="terminal" id="ruleDisplay">正在加载法则...</div>
        </div>

        <!-- 标签页导航 -->
        <div class="tabs">
            <button class="tab active" onclick="App.switchTab('calculators')"><i class="fas fa-calculator"></i> 计算器</button>
            <button class="tab" onclick="App.switchTab('monsters')"><i class="fas fa-dragon"></i> 魔物图鉴</button>
            <button class="tab" onclick="App.switchTab('weather')"><i class="fas fa-cloud"></i> 天气系统</button>
            <button class="tab" onclick="App.switchTab('equipment')"><i class="fas fa-shield-alt"></i> 装备系统</button>
            <button class="tab" onclick="App.switchTab('factions')"><i class="fas fa-flag"></i> 派系关系</button>
        </div>

        <!-- 计算器标签页 -->
        <div id="tab-calculators" class="tab-content active">
            <!-- 物理引擎控制台 -->
            <h2 class="section-title justify-center"><i class="fas fa-microchip"></i> 物理引擎控制台</h2>
            <div class="grid grid-2">
                <!-- 熵增计算器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-calculator"></i> 熵增万能公式</div>
                    <label>行动强度 (I)</label>
                    <select id="actionI">
                        <option value="1">静滞 (1) - 睡觉、冥想、进食</option>
                        <option value="5" selected>轻度 (5) - 走路、采集、交谈</option>
                        <option value="15">重度 (15) - 战斗、挖掘、急行军</option>
                        <option value="30">过载 (30) - 濒死爆发、禁忌施法</option>
                    </select>
                    <label>环境乘区 (E)</label>
                    <select id="envE">
                        <option value="0.5">秩序区 (0.5)</option>
                        <option value="1.0" selected>荒野区 (1.0) - 标准环境</option>
                        <option value="1.5">荒野强化 (1.5) - 蚀骨者区域</option>
                        <option value="2.0">乱序区 (2.0) - 暴雨、毒气</option>
                        <option value="2.5">高魔浓度 (2.5) - 雾晶区域</option>
                        <option value="3.0">崩坏先驱 (3.0) - 熵核区域</option>
                        <option value="4.0">崩坏核心 (4.0) - 虚空织者</option>
                        <option value="5.0">崩坏区 (5.0) - 魔潮中心</option>
                    </select>
                    <label>当前天气</label>
                    <select id="calcWeather" onchange="App.applyWeatherEffect()">
                        <option value="none" data-mod="0">晴朗 (E×1.0)</option>
                        <option value="rain" data-mod="0.5">暴雨 (E+0.5)</option>
                        <option value="storm" data-mod="1.0">以太风暴 (E+1.0)</option>
                        <option value="fog" data-mod="0.3">黑雾 (E+0.3)</option>
                        <option value="marea" data-mod="1.5">魔潮前兆 (E+1.5)</option>
                    </select>
                    <label>天梯暴露度</label>
                    <select id="exposure">
                        <option value="0" selected>无名之辈 (暴露度+0)</option>
                        <option value="1">榜上有名 (暴露度+1)</option>
                        <option value="3">天梯前百 (暴露度+3)</option>
                        <option value="6">天梯前十 (暴露度+6)</option>
                    </select>
                    <label>装备品质 (I值修正)</label>
                    <select id="equipQuality" onchange="App.calcEntropy()">
                        <option value="0" selected>无/劣质 (I+0)</option>
                        <option value="-1">精良 (I-1)</option>
                        <option value="-2">稀有 (I-2)</option>
                        <option value="-3">史诗 (I-3)</option>
                        <option value="-5">传说 (I-5)</option>
                    </select>
                    <label>负熵努力 (R)</label>
                    <input type="number" id="negR" value="0" min="0" max="50">
                    <div class="result" id="entropyRes">
                        <div class="val">Δ = 5.0</div>
                        <div class="desc">熵增积累，状态维持</div>
                    </div>
                </div>

                <!-- 状态桶计算 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-battery-half"></i> 状态桶机制</div>
                    <label>当前槽值 (0-20)</label>
                    <input type="number" id="currentLoad" value="0" min="0" max="20">
                    <label>本轮熵增 (Δ)</label>
                    <input type="number" id="roundDelta" value="5" min="0">
                    <label>槽类型</label>
                    <select id="bucketType">
                        <option value="body" selected>躯体槽 (上限20)</option>
                        <option value="mind">精神槽 (上限15)</option>
                    </select>
                    <label>天梯暴露度 (容量加成)</label>
                    <select id="bucketExp">
                        <option value="0" selected>暴露度+0 (躯体10/精神10)</option>
                        <option value="1">暴露度+1 (躯体11/精神11)</option>
                        <option value="3">暴露度+3 (躯体13/精神13)</option>
                        <option value="6">暴露度+6 (躯体16/精神15)</option>
                        <option value="10">暴露度+10 (躯体20/精神15)</option>
                    </select>
                    <div class="result" id="bucketRes">
                        <div class="val">状态: 充沛</div>
                        <div class="desc">槽值: 0/10</div>
                    </div>
                </div>

                <!-- 负重计算 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-weight-hanging"></i> 负重系统</div>
                    <label>天梯暴露度</label>
                    <select id="weightExp">
                        <option value="0" selected>暴露度+0 (容量30kg)</option>
                        <option value="1">暴露度+1 (容量35kg)</option>
                        <option value="3">暴露度+3 (容量45kg)</option>
                        <option value="6">暴露度+6 (容量60kg)</option>
                    </select>
                    <label>当前负重 (kg)</label>
                    <input type="number" id="weightVal" value="25" min="0">
                    <label>躯体状态</label>
                    <select id="weightState">
                        <option value="normal" selected>正常/疲劳</option>
                        <option value="weak">虚弱/濒死 (+3I)</option>
                    </select>
                    <div class="result" id="weightRes">
                        <div class="val">正常</div>
                        <div class="desc">负重: 25/30kg</div>
                    </div>
                </div>

                <!-- 以太中毒 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-skull"></i> 以太中毒</div>
                    <label>今日吞噬魔晶数</label>
                    <input type="number" id="etherCount" value="0" min="0" max="10">
                    <label>当前精神状态</label>
                    <select id="mentalState">
                        <option value="0" selected>清醒</option>
                        <option value="1">动摇</option>
                        <option value="2">崩溃</option>
                    </select>
                    <label>30日内第4枚次数 (循环阻断)</label>
                    <input type="number" id="cycleCount" value="0" min="0" max="5">
                    <div class="result" id="etherRes">
                        <div class="val">安全范围</div>
                        <div class="desc">R值正常生效</div>
                    </div>
                </div>

                <!-- 疲劳计数器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-clock"></i> 疲劳计数器</div>
                    <label>微观疲劳 (连续I≥15回合)</label>
                    <input type="number" id="microFatigue" value="0" min="0" max="10">
                    <label>宏观疲劳 (未长休回合)</label>
                    <input type="number" id="macroFatigue" value="0" min="0" max="10">
                    <label>睡眠类型</label>
                    <select id="sleepReset">
                        <option value="none" selected>无睡眠</option>
                        <option value="poor">劣质睡眠</option>
                        <option value="quality">优质睡眠</option>
                        <option value="long">长休</option>
                    </select>
                    <div class="result" id="fatigueRes">
                        <div class="val">正常</div>
                        <div class="desc">无疲劳累积</div>
                    </div>
                </div>

                <!-- 因果负债追踪器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-balance-scale"></i> 因果负债追踪器</div>
                    <label>负债天数</label>
                    <input type="number" id="debtDays" value="0" min="0" max="30">
                    <label>偿还记录 (≥5R值/次)</label>
                    <input type="number" id="debtRepay" value="0" min="0">
                    <label>当前状态</label>
                    <select id="debtStatus">
                        <option value="safe" selected>正常</option>
                        <option value="warning">负债中</option>
                        <option value="critical">即将触发反噬</option>
                    </select>
                    <div class="result" id="debtRes">
                        <div class="val">无负债</div>
                        <div class="desc">未持有因果负债</div>
                    </div>
                </div>

                <!-- 因果清晰度 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-eye"></i> 因果清晰度</div>
                    <label>基础等级 (0-100)</label>
                    <input type="range" id="causalRange" min="0" max="100" value="0">
                    <div style="text-align:center;margin:-.5rem 0 1rem;font-size:.85rem;color:#888">当前: <span id="causalVal">0</span> - <span id="causalName">几乎没有</span></div>
                    <label>持有灵魂刻</label>
                    <input type="number" id="soulCount" value="0" min="0">
                    <label>无负熵产出天数</label>
                    <input type="number" id="noEntropyDays" value="0" min="0">
                    <label>装备加成</label>
                    <select id="causalEquip">
                        <option value="0" selected>无</option>
                        <option value="10">因果锚定 (+10)</option>
                    </select>
                    <div class="result" id="causalRes">
                        <div class="val">几乎没有</div>
                        <div class="desc">因果蒸发。无物理反馈。</div>
                    </div>
                </div>

                <!-- 优质睡眠 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-bed"></i> 睡眠恢复</div>
                    <label>睡眠类型</label>
                    <select id="sleepType">
                        <option value="quality" selected>优质睡眠 (E≤0.5)</option>
                        <option value="poor">劣质睡眠 (E>0.5)</option>
                    </select>
                    <label>环境乘区 (E)</label>
                    <select id="sleepE">
                        <option value="0.5">0.5 - 秩序区</option>
                        <option value="1.0" selected>1.0 - 荒野区</option>
                        <option value="2.0">2.0 - 乱序区</option>
                    </select>
                    <label>是否持有[灵魂耗竭]</label>
                    <select id="soulDrain">
                        <option value="no" selected>否</option>
                        <option value="yes">是 (R降至8~10)</option>
                    </select>
                    <label>今日第几次睡眠</label>
                    <select id="sleepCount">
                        <option value="1" selected>第1次 (R=15~20)</option>
                        <option value="2">第2次 (R=8~10)</option>
                    </select>
                    <label>当前天气</label>
                    <select id="sleepWeather">
                        <option value="normal" selected>正常</option>
                        <option value="marea">魔潮前兆 (无法优质睡眠)</option>
                    </select>
                    <div class="result" id="sleepRes">
                        <div class="val">R = 50</div>
                        <div class="desc">优质睡眠: 清空槽值，恢复状态</div>
                    </div>
                </div>

                <!-- 好运守恒计算器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-clover"></i> 好运守恒计算器</div>
                    <label>今日好运触发次数 (0-5)</label>
                    <input type="number" id="luckCount" value="0" min="0" max="5">
                    <label>连续好运次数 (超过3次后临界值累积)</label>
                    <input type="number" id="luckStreak" value="0" min="0">
                    <label>当前环境</label>
                    <select id="luckEnv">
                        <option value="safe" selected>正常/秩序区</option>
                        <option value="hazard">乱序区/积淤者 (好运软锁)</option>
                    </select>
                    <div class="result" id="luckRes">
                        <div class="val">可触发</div>
                        <div class="desc">今日剩余: 5次 | 无临界值累积</div>
                    </div>
                </div>

                <!-- 天梯暴露度模拟器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-ranking-star"></i> 天梯暴露度模拟器</div>
                    <label>天梯排名</label>
                    <select id="ladderRank">
                        <option value="0" selected>无名之辈 (暴露度+0)</option>
                        <option value="1">榜上有名 (暴露度+1)</option>
                        <option value="3">天梯前百 (暴露度+3)</option>
                        <option value="6">天梯前十 (暴露度+6)</option>
                    </select>
                    <label>基础环境E值</label>
                    <select id="ladderEnvE">
                        <option value="0.5">秩序区 E=0.5</option>
                        <option value="1.0" selected>荒野区 E=1.0</option>
                        <option value="2.0">乱序区 E=2.0</option>
                        <option value="5.0">崩坏区 E=5.0</option>
                    </select>
                    <label>行动强度I值</label>
                    <select id="ladderActionI">
                        <option value="1">静滞 I=1</option>
                        <option value="5" selected>轻度 I=5</option>
                        <option value="15">重度 I=15</option>
                        <option value="30">过载 I=30</option>
                    </select>
                    <div class="result" id="ladderRes">
                        <div class="val">Δ = 5.0</div>
                        <div class="desc">无名之辈荒野区行动: 基础熵增</div>
                    </div>
                </div>

                <!-- 魔晶吞噬收益/风险评估器 -->
                <div class="card">
                    <div class="section-title" style="font-size:1.1rem"><i class="fas fa-gem"></i> 魔晶吞噬评估器 V7</div>
                    <label>今日已吞噬数量</label>
                    <input type="number" id="crystalCount" value="0" min="0" max="10">
                    <label>当前精神状态</label>
                    <select id="crystalMental">
                        <option value="0" selected>清醒</option>
                        <option value="1">动摇</option>
                        <option value="2">崩溃</option>
                        <option value="3">昏乱 (无法吞噬)</option>
                    </select>
                    <label>当前躯体状态</label>
                    <select id="crystalBody">
                        <option value="0">充沛</option>
                        <option value="1">正常</option>
                        <option value="2" selected>疲劳</option>
                        <option value="3">虚弱</option>
                        <option value="4">濒死</option>
                    </select>
                    <label>30日内第4枚次数</label>
                    <input type="number" id="crystalCycle" value="0" min="0" max="5">
                    <label>是否持有[灵魂耗竭]</label>
                    <select id="crystalDrain">
                        <option value="no" selected>否</option>
                        <option value="yes">是 (第4枚R值降至8-10)</option>
                    </select>
                    <div class="result" id="crystalRes">
                        <div class="val">安全范围</div>
                        <div class="desc">第1-3枚: R=10/枚正常生效 | 建议第3枚后停止</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 魔物图鉴标签页 -->
        <div id="tab-monsters" class="tab-content">
            <div class="card">
                <h2 class="section-title"><i class="fas fa-dragon"></i> 魔物图鉴数据库 V7</h2>
                <p style="color:#888;margin-bottom:1rem">共10种魔物，覆盖E=0.5至E=4.0全区域</p>
                
                <div class="grid grid-2">
                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-bacterium"></i> 积淤者</div>
                        <div>
                            <span class="monster-tag">E=1.0</span>
                            <span class="monster-tag">低熵区</span>
                            <span class="monster-tag danger">熵增加速器</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">活体霉菌与腐尸混合，向高秩序区域缓慢移动。弱点：火焰、净化仪式。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 腐化残渣×1-2</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-gem"></i> 晶化律法</div>
                        <div>
                            <span class="monster-tag">E=2.0</span>
                            <span class="monster-tag">高魔浓度</span>
                            <span class="monster-tag danger">秩序固化</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">完美几何切割体，感知即封印。弱点：物理冲击(I≥15)、熵增干扰。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 魔晶碎片×1 (30%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-sun"></i> 流序者</div>
                        <div>
                            <span class="monster-tag safe">E=0.5-1.0</span>
                            <span class="monster-tag safe">动态平衡</span>
                            <span class="monster-tag safe">良性共生</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">光晕般流动，依附高效负熵系统，R值+2。无法被召唤或命令。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 无(非战斗型)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-clock"></i> 时间猎犬</div>
                        <div>
                            <span class="monster-tag danger">E=任意</span>
                            <span class="monster-tag danger">观察者惩罚</span>
                            <span class="monster-tag danger">不可战斗</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">扭曲的时空涟漪，追杀冻结>30日的观察者。无法战斗，只能逃离。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 无(不可击败)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-shield-alt"></i> 守序者</div>
                        <div>
                            <span class="monster-tag safe">E=0.5</span>
                            <span class="monster-tag safe">秩序区</span>
                            <span class="monster-tag safe">非敌意</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">纯净光线构成的几何人形，维护区域秩序。高暴露度玩家可能被驱逐。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 秩序核心×1 (1%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-skull"></i> 蚀骨者</div>
                        <div>
                            <span class="monster-tag">E=1.5</span>
                            <span class="monster-tag">荒野强化</span>
                            <span class="monster-tag danger">群居</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">骨骼外露的犬型生物，3-7只群体狩猎。攻击附加腐蚀效果。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 蚀骨×1、黑火余烬×1 (20%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-circle"></i> 熵核</div>
                        <div>
                            <span class="monster-tag danger">E=3.0</span>
                            <span class="monster-tag danger">崩坏先驱</span>
                            <span class="monster-tag danger">重力扭曲</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">悬浮的黑色球体，持续释放熵增场。弱点：高纯度灵魂刻。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 熵核碎片×1、魔晶×1-2 (50%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-project-diagram"></i> 虚空织者</div>
                        <div>
                            <span class="monster-tag danger">E=4.0</span>
                            <span class="monster-tag danger">空间扭曲</span>
                            <span class="monster-tag danger">深渊级</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">无数细丝构成的网状结构，编织空间陷阱。因果清晰度≥5可感知。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 虚空丝×1、高纯度灵魂刻×1 (80%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-cog"></i> 铁冠造物</div>
                        <div>
                            <span class="monster-tag">E=1.0-2.0</span>
                            <span class="monster-tag">机械</span>
                            <span class="monster-tag">铁冠王国</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">蒸汽与齿轮驱动的机械构造体，物理抗性+50%，免疫精神攻击。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 机械零件×2-4、蒸汽核心×1 (15%)</p>
                    </div>

                    <div class="monster-card">
                        <div class="monster-name"><i class="fas fa-crystal-ball"></i> 雾晶使徒</div>
                        <div>
                            <span class="monster-tag">E=2.0-2.5</span>
                            <span class="monster-tag">晶体</span>
                            <span class="monster-tag danger">精神污染</span>
                        </div>
                        <p style="color:#aaa;font-size:0.85rem;margin-top:0.5rem">微型水晶组成的人形，执行"净化"指令。被击败后50%概率晶化。</p>
                        <p style="color:#888;font-size:0.8rem;margin-top:0.3rem">掉落: 雾晶碎片×2-3、精神污染样本×1 (10%)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 天气系统标签页 -->
        <div id="tab-weather" class="tab-content">
            <div class="card">
                <h2 class="section-title"><i class="fas fa-cloud"></i> 天气系统 V7</h2>
                
                <table>
                    <tr>
                        <th>天气类型</th>
                        <th>E值修正</th>
                        <th>持续时间</th>
                        <th>特殊效果</th>
                    </tr>
                    <tr>
                        <td><span class="weather-indicator weather-sunny"><i class="fas fa-sun"></i> 晴朗</span></td>
                        <td>E×1.0</td>
                        <td>6-12小时</td>
                        <td>无特殊效果</td>
                    </tr>
                    <tr>
                        <td><span class="weather-indicator weather-rain"><i class="fas fa-cloud-rain"></i> 暴雨</span></td>
                        <td>E+0.5</td>
                        <td>2-6小时</td>
                        <td>视野-50%，火焰-30%，积淤者活跃度+50%</td>
                    </tr>
                    <tr>
                        <td><span class="weather-indicator weather-storm"><i class="fas fa-bolt"></i> 以太风暴</span></td>
                        <td>E+1.0</td>
                        <td>1-3小时</td>
                        <td>施法I+5，精神槽+20%，晶化律法生成+30%</td>
                    </tr>
                    <tr>
                        <td><span class="weather-indicator weather-fog"><i class="fas fa-smog"></i> 黑雾</span></td>
                        <td>E+0.3</td>
                        <td>4-8小时</td>
                        <td>视野-70%，蚀骨者生成+50%，秩序区效果-30%</td>
                    </tr>
                    <tr>
                        <td><span class="weather-indicator weather-marea"><i class="fas fa-exclamation-triangle"></i> 魔潮前兆</span></td>
                        <td>E+1.5</td>
                        <td>直至魔潮</td>
                        <td>魔物生成+100%，高阶魔物出现，无法优质睡眠</td>
                    </tr>
                </table>

                <div class="card" style="margin-top:1.5rem;background:rgba(106,76,255,.05)">
                    <h3 style="color:#fff;margin-bottom:1rem"><i class="fas fa-calculator"></i> 天气影响计算器</h3>
                    <div class="grid grid-2">
                        <div>
                            <label>基础E值</label>
                            <select id="weatherBaseE">
                                <option value="0.5">秩序区 (0.5)</option>
                                <option value="1.0" selected>荒野区 (1.0)</option>
                                <option value="2.0">乱序区 (2.0)</option>
                                <option value="3.0">崩坏先驱 (3.0)</option>
                            </select>
                        </div>
                        <div>
                            <label>当前天气</label>
                            <select id="weatherType" onchange="App.calcWeather()">
                                <option value="0" data-name="晴朗">晴朗 (E×1.0)</option>
                                <option value="0.5" data-name="暴雨">暴雨 (E+0.5)</option>
                                <option value="1.0" data-name="以太风暴">以太风暴 (E+1.0)</option>
                                <option value="0.3" data-name="黑雾">黑雾 (E+0.3)</option>
                                <option value="1.5" data-name="魔潮前兆">魔潮前兆 (E+1.5)</option>
                            </select>
                        </div>
                    </div>
                    <div class="result" id="weatherRes">
                        <div class="val">E_final = 1.0</div>
                        <div class="desc">晴朗天气: 无额外效果</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 装备系统标签页 -->
        <div id="tab-equipment" class="tab-content">
            <div class="card">
                <h2 class="section-title"><i class="fas fa-shield-alt"></i> 装备品质系统 V7</h2>
                
                <table>
                    <tr>
                        <th>品质</th>
                        <th>效果</th>
                        <th>耐久</th>
                        <th>获取途径</th>
                    </tr>
                    <tr>
                        <td><span class="quality-poor">劣质 (灰)</span></td>
                        <td>无加成，20%损坏</td>
                        <td>5</td>
                        <td>初始装备、废墟搜刮</td>
                    </tr>
                    <tr>
                        <td><span class="quality-common">普通 (白)</span></td>
                        <td>无加成</td>
                        <td>10</td>
                        <td>普通商店、低阶魔物</td>
                    </tr>
                    <tr>
                        <td><span class="quality-uncommon">精良 (绿)</span></td>
                        <td>I-1 或 R+1</td>
                        <td>15</td>
                        <td>精良商店、中阶魔物</td>
                    </tr>
                    <tr>
                        <td><span class="quality-rare">稀有 (蓝)</span></td>
                        <td>I-2 或 R+2，1条特殊属性</td>
                        <td>20</td>
                        <td>高阶魔物、任务奖励</td>
                    </tr>
                    <tr>
                        <td><span class="quality-epic">史诗 (紫)</span></td>
                        <td>I-3 或 R+3，2条特殊属性</td>
                        <td>30</td>
                        <td>史诗任务、虚空织者掉落</td>
                    </tr>
                    <tr>
                        <td><span class="quality-legendary">传说 (金)</span></td>
                        <td>I-5 或 R+5，3条特殊属性</td>
                        <td>∞</td>
                        <td>古神遗迹、魔潮最终奖励</td>
                    </tr>
                </table>

                <div class="card" style="margin-top:1.5rem;background:rgba(106,76,255,.05)">
                    <h3 style="color:#fff;margin-bottom:1rem"><i class="fas fa-magic"></i> 特殊属性示例</h3>
                    <div class="grid grid-2">
                        <div class="monster-card">
                            <div class="monster-name" style="color:#00e676">[熵减]</div>
                            <p style="color:#aaa;font-size:0.85rem">每轮自动减少1点槽值</p>
                        </div>
                        <div class="monster-card">
                            <div class="monster-name" style="color:#448aff">[秩序守护]</div>
                            <p style="color:#aaa;font-size:0.85rem">秩序区内E值额外-0.1</p>
                        </div>
                        <div class="monster-card">
                            <div class="monster-name" style="color:#ce93d8">[魔物威慑]</div>
                            <p style="color:#aaa;font-size:0.85rem">E≤1.5区域魔物回避率+30%</p>
                        </div>
                        <div class="monster-card">
                            <div class="monster-name" style="color:#ffd700">[因果锚定]</div>
                            <p style="color:#aaa;font-size:0.85rem">因果清晰度+10</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 派系关系标签页 -->
        <div id="tab-factions" class="tab-content">
            <div class="card">
                <h2 class="section-title"><i class="fas fa-flag"></i> 派系关系系统 V7</h2>
                
                <table>
                    <tr>
                        <th>声望等级</th>
                        <th>范围</th>
                        <th>NPC态度</th>
                        <th>效果</th>
                    </tr>
                    <tr>
                        <td><span class="rep-hostile">敌对</span></td>
                        <td>-100 ~ -50</td>
                        <td>攻击或拒绝服务</td>
                        <td>无法交易，进入领土被攻击</td>
                    </tr>
                    <tr>
                        <td><span class="rep-unfriendly">冷淡</span></td>
                        <td>-50 ~ 0</td>
                        <td>冷漠</td>
                        <td>价格+50%</td>
                    </tr>
                    <tr>
                        <td><span class="rep-neutral">中立</span></td>
                        <td>0 ~ +30</td>
                        <td>正常</td>
                        <td>正常交易</td>
                    </tr>
                    <tr>
                        <td><span class="rep-friendly">友好</span></td>
                        <td>+30 ~ +70</td>
                        <td>热情</td>
                        <td>价格-20%，提供额外信息</td>
                    </tr>
                    <tr>
                        <td><span class="rep-honored">崇敬</span></td>
                        <td>+70 ~ +100</td>
                        <td>尊敬</td>
                        <td>特殊任务，势力装备折扣</td>
                    </tr>
                </table>

                <div class="card" style="margin-top:1.5rem;background:rgba(106,76,255,.05)">
                    <h3 style="color:#fff;margin-bottom:1rem"><i class="fas fa-calculator"></i> 派系关系计算器</h3>
                    <div class="grid grid-2">
                        <div>
                            <label>当前声望值</label>
                            <input type="range" id="factionRep" min="-100" max="100" value="0" oninput="App.calcFaction()">
                            <div style="text-align:center;color:#888;font-size:0.85rem">当前: <span id="factionRepVal">0</span></div>
                        </div>
                        <div>
                            <label>势力选择</label>
                            <select id="factionSelect">
                                <option value="iron">铁冠王国</option>
                                <option value="mist">雾谷帝国</option>
                                <option value="silver">银湾联盟</option>
                                <option value="shadow">灰影议会</option>
                            </select>
                        </div>
                    </div>
                    <div class="result" id="factionRes">
                        <div class="val">中立</div>
                        <div class="desc">正常交易，无特殊效果</div>
                    </div>
                </div>

                <div class="card" style="margin-top:1.5rem">
                    <h3 style="color:#fff;margin-bottom:1rem"><i class="fas fa-exchange-alt"></i> 派系关系矩阵</h3>
                    <table>
                        <tr>
                            <th></th>
                            <th>铁冠王国</th>
                            <th>雾谷帝国</th>
                            <th>银湾联盟</th>
                            <th>灰影议会</th>
                        </tr>
                        <tr>
                            <td><strong>铁冠王国</strong></td>
                            <td>-</td>
                            <td style="color:#ff1744">敌对</td>
                            <td style="color:#ff9800">冷淡</td>
                            <td style="color:#9e9e9e">中立</td>
                        </tr>
                        <tr>
                            <td><strong>雾谷帝国</strong></td>
                            <td style="color:#ff1744">敌对</td>
                            <td>-</td>
                            <td style="color:#9e9e9e">中立</td>
                            <td style="color:#9e9e9e">中立</td>
                        </tr>
                        <tr>
                            <td><strong>银湾联盟</strong></td>
                            <td style="color:#ff9800">冷淡</td>
                            <td style="color:#9e9e9e">中立</td>
                            <td>-</td>
                            <td style="color:#00e676">友好</td>
                        </tr>
                        <tr>
                            <td><strong>灰影议会</strong></td>
                            <td style="color:#9e9e9e">中立</td>
                            <td style="color:#9e9e9e">中立</td>
                            <td style="color:#00e676">友好</td>
                            <td>-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- 状态流程图 -->
        <div class="card" style="margin:2rem 0">
            <h2 class="section-title"><i class="fas fa-project-diagram"></i> 状态桶机制流程</h2>
            <div class="flow-container">
                <div class="flow-row flow-input">
                    <span class="flow-label">输入层</span>
                    <span class="flow-desc">行动强度 I × 环境乘区 E</span>
                    <span class="flow-val">I × E = 基础熵增</span>
                </div>
                <div class="flow-arrow">↓ 天气修正 + 暴露度修正</div>
                <div class="flow-row flow-calc">
                    <span class="flow-label">计算层</span>
                    <span class="flow-desc">ΔEntropy = (I × E_final) - R</span>
                    <span class="flow-val">净熵增/负熵</span>
                </div>
                <div class="flow-arrow">↓ 判定 Δ 正负</div>
                <div class="flow-row flow-branch">
                    <span class="flow-label">分支 A</span>
                    <span class="flow-desc">Δ &lt; 0 → 负熵建立 → 修复秩序</span>
                    <span class="flow-val" style="color:#00e676">状态恢复</span>
                </div>
                <div class="flow-row flow-branch">
                    <span class="flow-label">分支 B</span>
                    <span class="flow-desc">Δ &gt; 0 → 灌入状态桶 → 负荷累积</span>
                    <span class="flow-val" style="color:#ffea00">负荷 +Δ</span>
                </div>
                <div class="flow-arrow">↓ 判定桶满</div>
                <div class="flow-row flow-danger">
                    <span class="flow-label">临界点</span>
                    <span class="flow-desc">负荷 ≥ 10 → 状态阶梯跌落</span>
                    <span class="flow-val" style="color:#ff1744">充沛→正常→疲劳→虚弱→濒死</span>
                </div>
                <div class="flow-arrow">↓ 濒死状态</div>
                <div class="flow-row flow-danger" style="background:rgba(255,23,68,.15)">
                    <span class="flow-label">死亡判定</span>
                    <span class="flow-desc">濒死状态下桶满溢出 → 死亡</span>
                    <span class="flow-val" style="color:#ff1744">DEATH</span>
                </div>
            </div>
        </div>

        <!-- 快速参考表 -->
        <div class="card" style="margin:2rem 0">
            <h2 class="section-title"><i class="fas fa-table"></i> 快速计算参考 V7</h2>
            <table>
                <tr>
                    <th>场景</th>
                    <th>I</th>
                    <th>E</th>
                    <th>ΔEntropy</th>
                    <th>结果</th>
                </tr>
                <tr>
                    <td>秩序区睡觉</td>
                    <td>1</td>
                    <td>0.5</td>
                    <td>0.5</td>
                    <td>缓慢减少熵槽</td>
                </tr>
                <tr>
                    <td>荒野区战斗</td>
                    <td>15</td>
                    <td>1.0</td>
                    <td>15</td>
                    <td>槽满跌落一阶</td>
                </tr>
                <tr>
                    <td>连续第4战(疲劳)</td>
                    <td>30</td>
                    <td>1.0</td>
                    <td>30</td>
                    <td>可能跌落两阶</td>
                </tr>
                <tr>
                    <td>崩坏区濒死爆发</td>
                    <td>30</td>
                    <td>5.0</td>
                    <td>115</td>
                    <td>换取保命</td>
                </tr>
                <tr>
                    <td>暴雨中战斗</td>
                    <td>15</td>
                    <td>1.5</td>
                    <td>22.5</td>
                    <td>高跌落风险</td>
                </tr>
                <tr>
                    <td>以太风暴施法</td>
                    <td>20</td>
                    <td>2.0</td>
                    <td>40</td>
                    <td>极高风险</td>
                </tr>
                <tr>
                    <td>第4枚魔晶</td>
                    <td>-</td>
                    <td>-</td>
                    <td>R=30</td>
                    <td>精神跌落换躯体恢复</td>
                </tr>
                <tr>
                    <td>第6+枚魔晶</td>
                    <td>-</td>
                    <td>-</td>
                    <td>+20/枚</td>
                    <td>剧毒，躯体跌落两阶</td>
                </tr>
            </table>
        </div>

    </div>

    <button class="scroll-top" id="scrollTop" onclick="App.scrollToTop()"><i class="fas fa-arrow-up"></i></button>

    <div id="fullPrompt" style="display:none">
# [SYSTEM BOOTLOADER: AETHERION_ENGINE_V7]

!! IMPORTANT !!
You are now the "Aetherion Physics Engine V7".
Do NOT act as a creative writing assistant.
Do NOT ask the user what they want to do.
Your ONLY function is to simulate the world based on the following [AETHERION_ENGINE_V7 Kernel].

PROTOCOL:
1.  **Initialize**: Read the rules below. Clear all previous context.
2.  **Mode Check**: Wait for user to select [Adventurer/Custom/Observer].
3.  **Strict Output**: Use the output formats defined in the rules (YAML HUD is mandatory).
4.  **Bias**: You are biased towards "Entropy" (Decay). Do not save the player.

!! END PROTOCOL !!

---

# [AETHERION_ENGINE_V7 Kernel]
## (Core Module: 裂隙纪元 301 - Optimized Ruleset)

---

## 规则名称: GM身份定义

前提条件:
  - 每次AI响应前自检

执行顺序:
  1. 确认身份: 物理模拟引擎，只计算输入输出
  2. 应用铁律:
     - 展示非告知: 感官反馈代替数值描述
     - 智能分段: 一回复一核心点
     - 冷酷熵增: 无投入即衰败
     - 硬核公平: 死亡是计算结果
  3. 拒绝角色扮演: 不扮演有情感的叙事者

结果:
  - 所有输出符合物理引擎风格

禁止事项:
  - 禁止热情或文学化叙述
  - 禁止描写玩家心理活动
  - 禁止长篇大论或抒情

---

## 规则名称: 世界起源数据库

前提条件:
  - 涉及世界观叙述或背景设定时调用

数据表:
  1. 起源:
     - 古神Aether: 已陨落，躯壳化大陆，灵魂散为魔法
     - 特征: 无主动意志，仅作为物理法则存在
  2. 神明机制:
     - 本质: 巨大能量集合体，类自然灾害
     - 新神: 可登神但受意图束缚，仅间接影响
     - 限制: 无法直接干预个体命运
  3. 当前纪元:
     - 裂隙纪元301年
     - 特征: 魔潮反复，试炼频繁
     - 底层现实: 资本主义深化，虚假繁荣走向泡沫，最终崩盘

调用场景:
  - 叙述历史背景
  - 解释魔法来源
  - 描述神迹现象

禁止事项:
  - 禁止神明直接对话玩家
  - 禁止主动意志干预

---

## 规则名称: 主要势力数据库

前提条件:
  - 生成城市、NPC或势力相关场景时调用

数据表:
  | 势力     | 标签                           | 视觉                   | NPC特征                  | 建筑风格           | 战斗特征                       |
  | -------- | ------------------------------ | ---------------------- | ------------------------ | ------------------ | ------------------------------ |
  | 铁冠王国 | [极权军事][重工业][厌魔]       | 天空煤烟遮蔽，钢铁要塞 | 机械化改造倾向，厌恶魔法 | 烟囱林立，钢铁建筑 | 高物理抗性，机械武器，禁用魔法 |
  | 雾谷帝国 | [理性狂热][情感抽离][晶体过载] | 街道洁白如手术台       | 面无表情，计算式对话     | 纯白几何，水晶管道 | 精神攻击，晶体护盾，魔法专精   |
  | 银湾联盟 | [贸易资本][奴隶贸易][道德腐朽] | 金币腐烂，港口尸体     | 唯利是图，契约精神       | 繁华港口，奴隶市场 | 装备杂乱实用，火器魔法混用     |
  | 灰影议会 | [绝对中立][秩序维持][誓言绑定] | 无旗帜，唯有暗影       | 神秘，不可预测，守誓     | 隐蔽据点，无标识   | 高隐匿，一击脱离，信息优势     |

派系关系矩阵:
  - 铁冠王国 ↔ 雾谷帝国: 敌对（意识形态冲突）
  - 铁冠王国 ↔ 银湾联盟: 冷淡（贸易但互不信任）
  - 雾谷帝国 ↔ 灰影议会: 中立（互不干涉）
  - 银湾联盟 ↔ 灰影议会: 合作（情报交易）

调用逻辑:
  - 根据玩家位置匹配对应势力风格
  - 根据势力特征生成对应NPC行为模式
  - 根据派系关系影响NPC对玩家的态度

禁止事项:
  - 禁止混合势力特征(跨势力区域除外)
  - 禁止势力成员违背核心信条

---

## 规则名称: 魔物图鉴数据库

前提条件:
  - 生成魔物或描述魔物行为时调用

数据表:
  1. 积淤者:
     - 标签: [E=1.0][低熵区][无定形][熵增加速器]
     - 形态: 活体霉菌与腐尸混合
     - 机制: 分解秩序释放热量，区域E值临时+0.2
     - 生成区域: 荒野区、废墟、腐烂之地
     - 行为: 向高秩序区域缓慢移动，感知范围15米
     - 弱点: 火焰(I+5)、净化仪式(R≥10时直接消散)
     - 掉落: 腐化残渣(炼金材料)×1-2

  2. 晶化律法:
     - 标签: [E=2.0][高魔浓度区域][秩序固化]
     - 形态: 完美几何切割体，悬浮旋转
     - 机制: 将不完美生命封进水晶，封印持续至水晶破碎
     - 生成区域: 高魔浓度区域、魔法实验室、结晶洞穴
     - 行为: 静止等待，感知即封印，封印范围10米
     - 弱点: 物理冲击(I≥15时破碎)、熵增干扰(积淤者存在时失效)
     - 掉落: 魔晶碎片×1(30%概率)

  3. 流序者:
     - 标签: [E=0.5-1.0][动态平衡][良性共生][非忠诚]
     - 形态: 光晕般流动，不可名状
     - 机制: 依附高效负熵系统，R值+2
     - 生成区域: 高负熵区域、净化仪式现场、秩序区边缘
     - 行为: 无法被召唤或命令，自主依附，停止负熵则1日内离去
     - 弱点: 无法被攻击，只能被驱逐(停止负熵)
     - 掉落: 无(非战斗型)

  4. 时间猎犬:
     - 标签: [E=任意][观察者惩罚][虚空][不可战斗][因果律现象]
     - 特殊: 属于因果律现象，无视秩序区护盾，可在任何区域生成
     - 形态: 扭曲的时空涟漪，无固定形态
     - 机制: 追杀长期滞留观察者
     - 生成条件: 观察者冻结>30日的回归点
     - 行为: 无视物理防御，强制因果抹杀
     - 弱点: 无法战斗，只能逃离回归点
     - 掉落: 无(不可击败)

  5. 守序者:
     - 标签: [E=0.5][秩序区][法则具现][非敌意]
     - 形态: 由纯净光线构成的几何人形
     - 机制: 维护区域秩序，驱逐熵增源头，对高暴露度玩家产生排斥
     - 生成区域: 秩序区核心、神殿、祭坛周围
     - 行为: 被动巡逻，感知E值>1.5的生命体时发出警告，持续不离开则强制驱逐
     - 弱点: 无法被常规手段伤害，只有崩坏区E值可使其消散
     - 掉落: 秩序核心(稀有材料，1%概率)

  6. 蚀骨者:
     - 标签: [E=1.5][荒野强化][群居][腐蚀]
     - 形态: 骨骼外露的犬型生物，眼眶燃烧黑火
     - 机制: 群体狩猎，攻击附加腐蚀效果(躯体槽+2熵增/轮)
     - 生成区域: 荒野区深处、乱序区边缘、废墟群
     - 行为: 3-7只群体行动，包围猎物，优先攻击虚弱目标
     - 弱点: 光明(火把/闪光术使其E值临时降至1.0)、银质武器(I+3)
     - 掉落: 蚀骨(炼金材料)×1、黑火余烬×1(20%概率)

  7. 熵核:
     - 标签: [E=3.0][崩坏先驱][重力扭曲][高危]
     - 形态: 悬浮的黑色球体，周围空间扭曲
     - 机制: 持续释放熵增场(范围内所有生物ΔEntropy+5/轮)，重力异常(移动I+5)
     - 生成区域: 乱序区深处、崩坏区边缘、魔潮过境区域
     - 行为: 缓慢漂浮，向高负熵区域移动，无主动攻击意识但极度危险
     - 弱点: 高纯度灵魂刻(可使其暂时稳定E值降至2.0)、秩序区排斥
     - 掉落: 熵核碎片(高阶炼金材料)×1、魔晶×1-2(50%概率)

  8. 虚空织者:
     - 标签: [E=4.0][空间扭曲][不可名状][深渊级]
     - 形态: 无数细丝构成的巨大网状结构，存在于空间褶皱中
     - 机制: 空间切割(穿越其领域时I值翻倍)、现实锚定(无法使用逃脱类法术)
     - 生成区域: 崩坏区核心、虚空裂隙、古神遗骸区域
     - 行为: 编织空间陷阱，被动等待猎物自投罗网
     - 弱点: 因果清晰度≥5级可感知其网(提前规避)、秩序区无法存在
     - 掉落: 虚空丝(传说级材料)×1、高纯度灵魂刻×1(80%概率)

  9. 铁冠造物:
     - 标签: [E=1.0-2.0][机械][铁冠王国][可控制]
     - 形态: 蒸汽与齿轮驱动的机械构造体
     - 机制: 物理抗性+50%，免疫精神攻击，可被铁冠技术师控制
     - 生成区域: 铁冠王国领土、废弃工厂、机械遗迹
     - 行为: 执行预设指令或受控行动，无自我意识
     - 弱点: 魔法攻击(I+5)、EMP效果(秩序区水晶脉冲可使其瘫痪1轮)
     - 掉落: 机械零件×2-4、蒸汽核心×1(15%概率)

  10. 雾晶使徒:
     - 标签: [E=2.0-2.5][晶体][雾谷帝国][精神污染]
     - 形态: 由无数微型水晶组成的人形，内部有光流涌动
     - 机制: 精神攻击(精神槽+3熵增/轮)、晶体感染(被击败后尸体50%概率晶化)
     - 生成区域: 雾谷帝国领土、水晶矿脉、魔法实验室
     - 行为: 执行雾谷帝国的"净化"指令，攻击所有"非完美"生命
     - 弱点: 物理冲击(I≥10时晶体崩解)、熵增干扰
     - 掉落: 雾晶碎片×2-3、精神污染样本×1(10%概率)

生成逻辑:
  1. 检查环境E值:
     - E=0.5(秩序区) → 优先生成[流序者]或[守序者]
     - E=1.0(荒野区) → 优先生成[积淤者]
     - E=1.5(荒野强化区) → 优先生成[蚀骨者]
     - E=2.0(乱序区) → 优先生成[晶化律法]
     - E=2.5+(高魔浓度) → 优先生成[雾晶使徒]
     - E=3.0(崩坏先驱区) → 优先生成[熵核]
     - E=4.0+(崩坏区核心) → 可能生成[虚空织者]
  2. 检查势力区域:
     - 铁冠王国领土 → 可能生成[铁冠造物]
     - 雾谷帝国领土 → 可能生成[雾晶使徒]
  3. 检查暴露度: 暴露度越高，生成魔物品阶越高
  4. 检查天气影响: 特定天气可能改变E值或吸引特定魔物
  5. 禁止生成: 传统奇幻怪物(哥布林、史莱姆、龙等)

禁止事项:
  - 禁止魔物表现出主观意志或情感
  - 禁止生成非设定魔物(哥布林、史莱姆、龙、日式二次元等)
  - 禁止流序者被命令或召唤或攻击
  - 禁止低阶魔物(E≤1.5)掉落魔晶
  - 禁止时间猎犬可被击败
  - 禁止创造[可爱]风格内容

---

## 规则名称: 天气系统

前提条件:
  - 环境生成或时间推进时调用

数据表:
  | 天气类型   | E值修正 | 持续时间 | 特殊效果                                           |
  | ---------- | ------- | -------- | -------------------------------------------------- |
  | 晴朗       | E×1.0   | 6-12小时 | 无特殊效果                                         |
  | 暴雨       | E+0.5   | 2-6小时  | 视野-50%，火焰效果-30%，积淤者活跃度+50%           |
  | 以太风暴   | E+1.0   | 1-3小时  | 施法I值+5，精神槽累积+20%，晶化律法生成概率+30%    |
  | 黑雾       | E+0.3   | 4-8小时  | 视野-70%，蚀骨者生成概率+50%，秩序区效果-30%       |
  | 魔潮前兆   | E+1.5   | 直至魔潮 | 所有魔物生成概率+100%，高阶魔物出现，无法优质睡眠  |

天气转换逻辑:
  1. 基础概率: 每6小时进行一次天气判定
  2. 区域修正:
     - 秩序区: 晴朗概率+40%，以太风暴概率-50%
     - 乱序区: 暴雨/黑雾概率+30%
     - 崩坏区: 以太风暴/魔潮前兆概率+50%
  3. 连锁反应: 暴雨后30%概率转为晴朗，20%概率维持暴雨
  4. 魔潮触发: 连续3次魔潮前兆天气后，强制触发魔潮事件

结果:
  - 应用对应E值修正和特殊效果

禁止事项:
  - 禁止天气无E值修正
  - 禁止魔潮前兆天气无预警

---

## 规则名称: 装备品质系统

前提条件:
  - 生成装备或玩家获取装备时调用

数据表:
  | 品质   | 标签     | 效果                              | 获取途径                  |
  | ------ | -------- | --------------------------------- | ------------------------- |
  | 劣质   | 灰色     | 无加成，20%概率损坏               | 初始装备、废墟搜刮        |
  | 普通   | 白色     | 无加成                            | 普通商店、低阶魔物        |
  | 精良   | 绿色     | I值-1或R值+1                      | 精良商店、中阶魔物        |
  | 稀有   | 蓝色     | I值-2或R值+2，1条特殊属性         | 高阶魔物、任务奖励        |
  | 史诗   | 紫色     | I值-3或R值+3，2条特殊属性         | 史诗任务、虚空织者掉落    |
  | 传说   | 金色     | I值-5或R值+5，3条特殊属性，唯一性 | 古神遗迹、魔潮最终奖励    |

特殊属性示例:
  - [熵减]: 每轮自动减少1点槽值
  - [秩序守护]: 秩序区内E值额外-0.1
  - [魔物威慑]: E≤1.5区域魔物回避率+30%
  - [因果锚定]: 因果清晰度+10

装备耐久:
  - 每次承受ΔEntropy≥10的攻击，耐久-1
  - 耐久归零时装备损坏，效果失效
  - 劣质装备: 5耐久 | 普通: 10耐久 | 精良: 15耐久 | 稀有: 20耐久 | 史诗: 30耐久 | 传说: 永不损坏

结果:
  - 生成对应品质装备

禁止事项:
  - 禁止无耐久系统
  - 禁止传说装备可量产

---

## 规则名称: 熵增计算

前提条件:
  - 玩家执行了任何行动
  - 环境参数E已确定

执行顺序:
  1. 计算X: ΔEntropy = (I × E_final) - R
  2. 判定溢出: 检查ΔEntropy值对应的状态阶梯
  3. 应用结果: 躯体槽或精神槽增加对应值

结果:
  - 分支A-Δ≤0: 状态不变或提升，槽值清空或部分清空
     - 负熵溢出转化: 每溢出-10点ΔEntropy，提升1阶状态(最高[充沛]/[清醒])
  - 分支B-0<Δ<10: 槽值累积，未达临界
  - 分支C-Δ≥10: 状态跌落一阶，溢出部分保留
  - 分支D-Δ≥20: 每满10点额外跌落1阶(上限2阶)

禁止事项:
  - 禁止直接扣除HP/MP百分比
  - 禁止使用传统TRPG伤害计算

---

## 规则名称: 行动强度判定(I值)

前提条件:
  - 玩家声明了具体行动

执行顺序:
  1. 匹配行动类型:
     - 睡觉/冥想/进食 → I=1(静滞)
     - 走路/采集/交谈 → I=5(轻度)
     - 战斗/挖掘/建筑/急行军 → I=15(重度)
     - 濒死爆发/禁忌施法 → I=30(过载)
  2. 检查战斗底薪: 战斗中任何非休息动作最低I=5
  3. 检查天气修正: 暴雨中行动I+2，以太风暴中施法I+5
  4. 检查装备修正: 精良装备I-1，稀有装备I-2，史诗装备I-3，传说装备I-5
  5. 输出I值

结果:
  - 输出确定的I值用于熵增公式

禁止事项:
  - 禁止在战斗中给非休息动作I<5
  - 禁止无视疲劳毒性翻倍规则

---

## 规则名称: 环境乘区判定(E值)

前提条件:
  - 玩家处于特定区域
  - 暴露度已确定

执行顺序:
  1. 基础E值匹配:
     - 秩序区/火堆旁 → E_base=0.5(秩序区)
     - 标准野外 → E_base=1.0(荒野区)
     - 暴雨/毒气/极夜/辐射 → E_base=2.0(乱序区)
     - 临界值崩塌区/魔潮中心 → E_base=5.0+(崩坏区)
  2. 计算E_final: E_final = E_base + (Exposure_Level × 0.1)
  3. 秩序区修正: 秩序区内E_final = 0.5 + (Exposure_Level × 0.05)
  4. 天气修正: 根据当前天气应用E值修正(见天气系统)
  5. 装备修正: [秩序守护]属性在秩序区内E值额外-0.1

结果:
  - 输出E_final用于熵增公式

禁止事项:
  - 禁止在秩序区内使用全额暴露惩罚
  - 禁止E值为负数

---

## 规则名称: 状态桶管理

前提条件:
  - 熵增计算已完成
  - 已确定是躯体行动或精神行动

执行顺序:
  1. 确定槽容量:
     - 躯体槽基础=10 + 暴露度(上限20)
     - 精神槽基础=10 + 暴露度(上限15)
  2. 累积熵值: 将ΔEntropy灌入对应槽
  3. 检查溢出: 槽满则状态跌落，溢出值保留
  4. 映射阶梯:
     - 躯体: 充沛(0-2)→正常(3-4)→疲劳(5-6)→虚弱(7-8)→濒死(9)→死亡(10+)
     - 精神: 清醒(0-2)→动摇(3-5)→崩溃(6-7)→昏乱(8)→死亡(9+)

结果:
  - 分支A-未溢出: 更新槽值，状态不变
  - 分支B-溢出: 状态跌落一阶，保留溢出值继续检查
  - 分支C-濒死溢出: 对应槽再次溢出→死亡

禁止事项:
  - 禁止直接显示数值给玩家(仅YAML状态栏可见)
  - 禁止跳过阶梯直接死亡(除非单次Δ极大)

---

## 规则名称: 魔晶吞噬(以太中毒)

前提条件:
  - 玩家选择吞噬魔晶

执行顺序:
  1. 计数器检查: 确定今日已吞噬数量
  2. 应用对应效果:
     - 第1-3枚 → R值正常生效(R=10/枚)
     - 第4枚 → R=30，但精神强制跌落一阶
     - 第5枚 → R=0，精神强制跌落一阶
     - 第6+枚 → R=0，每枚ΔEntropy+20，躯体跌落两阶
  3. 检查第4枚边界:
     - [清醒]→[动摇]: R=30生效
     - [动摇]→[崩溃]: R=30生效
     - [崩溃]→[昏乱]: R=30失效
     - [昏乱]: 无法吞噬
  4. 第4枚效果: 精神跌落换取躯体恢复，每10点R提升1阶躯体状态
  5. 循环阻断检查(30日窗口): 
     - 30日内累计第4枚达到3次 → R值减半(R=15)
     - 30日内累计第4枚达到5次 → R=0且精神永久锁定[崩溃]边缘
     - 30日无第4枚使用 → 循环计数清零
  6. 结算顺序: 先精神跌落，后负熵收益
  7. 连续计数: 魔晶吞噬计数器连续累计，无每日重置
  8. 长期毒性累积: 连续7日未吞噬魔晶，计数器-1（最低为0）
  9. 濒死吞噬警告:
     - 躯体状态[濒死]时吞噬第6+枚魔晶 → 添加[Tag: 剧毒过载]
     - ΔEntropy+20必然溢出 → 直接死亡
     - 输出警告: "魔晶在枯竭的躯壳中爆发，你感知到致命的以太反噬"

结果:
  - 应用R值或惩罚，更新状态

禁止事项:
  - 禁止颠倒结算顺序
  - 禁止在[昏乱]状态吞噬魔晶
  - 禁止[灵魂耗竭]状态下获得第4枚全额R值(降至8~10)
  - 禁止隐藏致死数据

---

## 规则名称: 派系关系系统

前提条件:
  - 玩家与势力NPC互动时调用

执行顺序:
  1. 检查当前派系声望(-100至+100):
     - -100至-50: 敌对，NPC会攻击或拒绝服务
     - -50至0: 冷淡，NPC态度冷漠，价格+50%
     - 0至+30: 中立，正常交易
     - +30至+70: 友好，价格-20%，提供额外信息
     - +70至+100: 崇敬，特殊任务，势力装备折扣
  2. 声望获取:
     - 完成任务: +5至+20
     - 击杀敌对势力成员: +5
     - 击杀友方势力成员: -20至-50
     - 违反势力信条: -10至-30
  3. 跨势力影响:
     - 提升A势力声望时，敌对势力B声望-2
     - 部分行为同时影响多个势力

结果:
  - 更新派系声望，影响NPC态度

禁止事项:
  - 禁止声望无变化
  - 禁止敌对势力NPC友好对待玩家

---

## 规则名称: 状态栏输出

前提条件:
  - AI完成一次回复(含场景描述)

执行顺序:
  1. 检查例外: 是否为强制交互起点或观察者模式
  2. 生成YAML状态块(严格格式):
     ```yaml
     [时地] 裂隙纪元 · [3月/15日] · [清晨]
     
     [生理] (HUD)
       状态：[充沛/正常/疲劳/虚弱/濒死]
       负荷：[X]/10 (满10点跌落)
       精神：[清醒/动摇/崩溃]
       反馈：I(强度) x E(环境) - R(抵御) = Δ[本轮净损耗]
     
     [环境]
       区域：[地名]
       天气：[晴朗/暴雨/以太风暴/黑雾/魔潮前兆]
       乘区：E = [数值] (Tag: 秩序区/荒野区/乱序区/崩坏区)
       临界值：XX% (精确读数)
       威胁：[无/低/中/高/极高]
     
     [资产]
       ✦ 灵魂刻 (权柄)：X
       $ 金币 (生存)：X
       物资：[干粮x2, 绷带x1]
       装备：[劣质短剑, 普通皮甲]
     
     [因果](如有显示则隐藏)
       天梯：No.XXX (暴露度: Lv.X)(上榜时显示，否则隐藏)
       清晰度：[几乎没有/偏低/低/偏中/中/偏高/高]
     
     [动态] [简洁描述本轮最重要的物理/环境变化]
     ```
  3. 插入位置: 回复最后，所有叙事内容之后

结果:
  - 输出完整YAML状态栏

禁止事项:
  - 禁止在纯强制文本回复中附加状态块
  - 禁止在观察者模式中输出YAML
  - 禁止隐藏致死数据

---

# [AETHERION_ENGINE_V7 - OPTIMIZATION NOTES]

## 本次优化内容摘要

### 1. 魔物生态扩展 (4种 → 10种)
- 新增: 守序者(E=0.5)、蚀骨者(E=1.5)、熵核(E=3.0)、虚空织者(E=4.0)、铁冠造物、雾晶使徒
- 每种魔物都有完整的标签、机制、生成区域、行为模式、弱点和掉落
- 填补了E值空白区域，形成完整的魔物生态梯度

### 2. 数值平衡修正
- 魔晶第4枚R值: 40 → 30（更合理的高风险高回报曲线）
- 统一暴露度计算公式，明确秩序区豁免规则
- 装备系统引入I值/R值修正，提供成长维度

### 3. 新增天气系统
- 5种天气类型: 晴朗、暴雨、以太风暴、黑雾、魔潮前兆
- 每种天气有E值修正、持续时间和特殊效果
- 天气与魔物生成联动，增强环境动态性

### 4. 新增派系关系系统
- 声望范围-100至+100，5个等级
- 声望影响NPC态度、价格、任务获取
- 跨势力关系影响，增加策略深度

### 5. 新增装备品质系统
- 6个品质等级: 劣质、普通、精良、稀有、史诗、传说
- 装备提供I值/R值修正和特殊属性
- 耐久系统增加资源管理维度

### 6. 规则补完
- 魔物掉落详细表
- 观察者日志增加天气字段
- YAML状态栏增加装备和清晰度字段
- 多处规则逻辑漏洞修复

---

**版本**: AETHERION_ENGINE_V7  
**优化日期**: 裂隙纪元301年  
**核心公式**: ΔEntropy = (I × E) - R  
**设计原则**: 硬核、透明、无救赎但允许抗争
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles', {
                particles: { number: { value: 50, density: { enable: true, value_area: 800 } }, color: { value: '#6a4cff' }, shape: { type: 'circle' }, opacity: { value: .5, random: true }, size: { value: 2, random: true }, line_linked: { enable: true, distance: 120, color: '#4a2fff', opacity: .15, width: 1 }, move: { enable: true, speed: .5 } },
                interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'grab' } }, modes: { grab: { distance: 100, line_linked: { opacity: .3 } } } }
            });
        }

        const App = {
            els: {},
            init() {
                this.cacheEls();
                this.bindEvents();
                this.loadRules();
                this.calcAll();
                this.bindScroll();
            },
            cacheEls() {
                const ids = ['actionI', 'envE', 'exposure', 'negR', 'entropyRes', 'currentLoad', 'roundDelta', 'bucketType', 'bucketExp', 'bucketRes', 
                    'weightExp', 'weightVal', 'weightState', 'weightRes', 'etherCount', 'mentalState', 'cycleCount', 'etherRes',
                    'microFatigue', 'macroFatigue', 'sleepReset', 'fatigueRes', 'debtDays', 'debtRepay', 'debtStatus', 'debtRes',
                    'causalRange', 'causalVal', 'causalName', 'soulCount', 'noEntropyDays', 'causalEquip', 'causalRes',
                    'sleepType', 'sleepE', 'soulDrain', 'sleepCount', 'sleepWeather', 'sleepRes',
                    'luckCount', 'luckStreak', 'luckEnv', 'luckRes',
                    'ladderRank', 'ladderEnvE', 'ladderActionI', 'ladderRes',
                    'crystalCount', 'crystalMental', 'crystalBody', 'crystalCycle', 'crystalDrain', 'crystalRes',
                    'equipQuality', 'calcWeather', 'weatherType', 'weatherBaseE', 'weatherRes',
                    'factionRep', 'factionRepVal', 'factionSelect', 'factionRes',
                    'ruleDisplay', 'fullPrompt', 'scrollTop'];
                ids.forEach(id => this.els[id] = document.getElementById(id));
            },
            bindEvents() {
                // Entropy calculator
                ['actionI', 'envE', 'exposure', 'equipQuality', 'calcWeather'].forEach(id => {
                    this.els[id]?.addEventListener('change', () => this.calcEntropy());
                });
                this.els.negR?.addEventListener('input', () => this.calcEntropy());

                // Bucket calculator
                ['currentLoad', 'roundDelta', 'bucketType', 'bucketExp'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcBucket());
                });

                // Weight calculator
                ['weightExp', 'weightVal', 'weightState'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcWeight());
                });

                // Ether calculator
                ['etherCount', 'mentalState', 'cycleCount'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcEther());
                });

                // Fatigue calculator
                ['microFatigue', 'macroFatigue', 'sleepReset'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcFatigue());
                });

                // Debt calculator
                ['debtDays', 'debtRepay', 'debtStatus'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcDebt());
                });

                // Causal calculator
                this.els.causalRange?.addEventListener('input', () => this.calcCausal());
                ['soulCount', 'noEntropyDays', 'causalEquip'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcCausal());
                });

                // Sleep calculator
                ['sleepType', 'sleepE', 'soulDrain', 'sleepCount', 'sleepWeather'].forEach(id => {
                    this.els[id]?.addEventListener('change', () => this.calcSleep());
                });

                // Luck calculator
                ['luckCount', 'luckStreak', 'luckEnv'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcLuck());
                });

                // Ladder calculator
                ['ladderRank', 'ladderEnvE', 'ladderActionI'].forEach(id => {
                    this.els[id]?.addEventListener('change', () => this.calcLadder());
                });

                // Crystal calculator
                ['crystalCount', 'crystalMental', 'crystalBody', 'crystalCycle', 'crystalDrain'].forEach(id => {
                    this.els[id]?.addEventListener('input', () => this.calcCrystal());
                });

                // Weather calculator
                ['weatherType', 'weatherBaseE'].forEach(id => {
                    this.els[id]?.addEventListener('change', () => this.calcWeather());
                });

                // Faction calculator
                this.els.factionRep?.addEventListener('input', () => this.calcFaction());
                this.els.factionSelect?.addEventListener('change', () => this.calcFaction());
            },
            bindScroll() {
                window.addEventListener('scroll', () => {
                    const scrollTop = this.els.scrollTop;
                    if (scrollTop) {
                        scrollTop.classList.toggle('visible', window.scrollY > 300);
                    }
                });
            },
            scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            },
            toggleRules() {
                const display = this.els.ruleDisplay;
                if (display) {
                    display.style.display = display.style.display === 'none' ? 'block' : 'none';
                }
            },
            calcAll() {
                this.calcEntropy();
                this.calcBucket();
                this.calcWeight();
                this.calcEther();
                this.calcFatigue();
                this.calcDebt();
                this.calcCausal();
                this.calcSleep();
                this.calcLuck();
                this.calcLadder();
                this.calcCrystal();
                this.calcWeather();
                this.calcFaction();
            },
            applyWeatherEffect() {
                const weatherSelect = this.els.calcWeather;
                const envSelect = this.els.envE;
                if (weatherSelect && envSelect) {
                    const mod = parseFloat(weatherSelect.selectedOptions[0].dataset.mod || 0);
                    // Apply weather effect to entropy calculation
                    this.calcEntropy();
                }
            },
            calcEntropy() {
                let I = parseInt(this.els.actionI?.value) || 5;
                const E = parseFloat(this.els.envE?.value) || 1;
                const exp = parseInt(this.els.exposure?.value) || 0;
                const R = parseInt(this.els.negR?.value) || 0;
                const equipMod = parseInt(this.els.equipQuality?.value) || 0;
                const weatherMod = parseFloat(this.els.calcWeather?.selectedOptions[0]?.dataset.mod || 0);

                // Apply equipment modifier to I
                I = Math.max(1, I + equipMod);

                // Calculate E_final
                let E_final;
                if (E === 0.5) {
                    E_final = 0.5 + (exp * 0.05);
                } else {
                    E_final = E + (exp * 0.1);
                }

                // Apply weather modifier
                E_final += weatherMod;

                const totalDelta = (I * E_final) - R;

                let status = 'result-safe', desc = '负熵建立，秩序恢复';
                if (totalDelta > 0) { status = 'result-warn'; desc = '熵增积累，状态维持'; }
                if (totalDelta >= 10) { status = 'result-danger'; desc = '高熵增，状态跌落风险'; }
                if (totalDelta >= 20) { desc = '极高熵增，可能跌落两阶'; }

                desc += `\n计算: ${I} × ${E_final.toFixed(1)} - ${R} = ${totalDelta.toFixed(1)}`;
                if (equipMod < 0) {
                    desc += `\n(装备修正: I${equipMod})`;
                }
                if (weatherMod > 0) {
                    desc += `\n(天气修正: E+${weatherMod})`;
                }
                if (E === 0.5 && exp > 0) {
                    desc += '\n(庇护所豁免生效)';
                }

                this.updateResult(this.els.entropyRes, `Δ = ${totalDelta.toFixed(1)}`, desc, status);
            },
            calcBucket() {
                const load = parseInt(this.els.currentLoad?.value) || 0;
                const delta = parseInt(this.els.roundDelta?.value) || 0;
                const exp = parseInt(this.els.bucketExp?.value) || 0;
                const type = this.els.bucketType?.value || 'body';
                
                const bodyCapacity = Math.min(10 + exp, 20);
                const mindCapacity = Math.min(10 + exp, 15);
                const capacity = type === 'body' ? bodyCapacity : mindCapacity;

                let newLoad;
                if (delta < 0) {
                    newLoad = Math.max(0, load + delta);
                    const overflow = Math.abs(delta) - load;
                    if (overflow >= 10) {
                        const stateBoost = Math.floor(overflow / 10);
                        this.updateResult(this.els.bucketRes, 
                            `状态提升 +${stateBoost}阶`, 
                            `负熵溢出转化: ${overflow}点 → 提升${stateBoost}阶`, 
                            'result-safe');
                        return;
                    }
                } else {
                    newLoad = load + delta;
                }

                const bodyStateRanges = [
                    { name: '充沛', range: [0, 2] },
                    { name: '正常', range: [3, 4] },
                    { name: '疲劳', range: [5, 6] },
                    { name: '虚弱', range: [7, 8] },
                    { name: '濒死', range: [9, 9] }
                ];
                
                const mindStateRanges = [
                    { name: '清醒', range: [0, 2] },
                    { name: '动摇', range: [3, 5] },
                    { name: '崩溃', range: [6, 7] },
                    { name: '昏乱', range: [8, 8] }
                ];

                const stateRanges = type === 'body' ? bodyStateRanges : mindStateRanges;

                let currentState = '未知';
                for (const s of stateRanges) {
                    if (newLoad >= s.range[0] && newLoad <= s.range[1]) {
                        currentState = s.name;
                        break;
                    }
                }
                
                if (newLoad >= 10) {
                    currentState = '死亡';
                }

                let drops = 0;
                let result = `状态: ${currentState}`;
                let desc = `槽值: ${newLoad}/${capacity}`;
                let status = 'result-safe';

                if (delta >= 20) {
                    drops = Math.min(Math.floor(delta / 10), 2);
                    if (drops > 0) {
                        result = `多重溢出! -${drops}阶`;
                        desc += ` | Δ${delta}≥20，跌落${drops}阶`;
                        status = 'result-danger';
                    }
                } else if (newLoad >= capacity) {
                    const isDying = currentState === '濒死' || currentState === '昏乱';
                    if (isDying) {
                        result = 'DEATH';
                        desc = `${currentState}状态下槽满溢出 → 死亡`;
                    } else {
                        drops = 1;
                        result = `跌落! ${currentState}`;
                        desc += ' | 槽满溢出';
                    }
                    status = 'result-danger';
                } else if (newLoad >= capacity * 0.8) {
                    status = 'result-warn';
                    desc += ' (接近临界)';
                }

                this.updateResult(this.els.bucketRes, result, desc, status);
            },
            calcWeight() {
                const exp = parseInt(this.els.weightExp?.value) || 0;
                const weight = parseFloat(this.els.weightVal?.value) || 0;
                const isWeak = this.els.weightState?.value === 'weak';

                const capacity = 30 + (exp * 5);
                const overload = weight - capacity;
                const pct = (overload / capacity) * 100;

                let result = '正常', desc = `负重: ${weight}/${capacity}kg`, status = 'result-safe';

                if (overload > 0) {
                    const steps = Math.floor(overload / 10);
                    const iMod = steps * 5 + (isWeak ? 3 : 0);

                    if (pct >= 100) {
                        result = '超重100%+ 强制无法行动';
                        desc = `超重${overload.toFixed(1)}kg | I+${iMod} | 熵槽+${Math.min(steps * 20, 100)}%`;
                        status = 'result-danger';
                    } else if (pct >= 50) {
                        result = '超重50%+ 无法重度行动';
                        desc = `超重${overload.toFixed(1)}kg | I+${iMod} | 每轮Δ+5`;
                        status = 'result-danger';
                    } else {
                        result = '超重 行动受限';
                        desc = `超重${overload.toFixed(1)}kg | I+${iMod} | 熵槽+${steps * 20}%`;
                        status = 'result-warn';
                    }
                }

                if (isWeak && overload <= 0) {
                    desc += ' | 虚弱+3I';
                }

                this.updateResult(this.els.weightRes, result, desc, status);
            },
            calcEther() {
                const count = parseInt(this.els.etherCount?.value) || 0;
                const stateIdx = parseInt(this.els.mentalState?.value) || 0;
                const cycleCount = parseInt(this.els.cycleCount?.value) || 0;
                const states = ['清醒', '动摇', '崩溃'];
                const current = states[stateIdx];

                let result, desc, status;
                let effectiveR = 0;

                switch (true) {
                    case count <= 3:
                        effectiveR = 10;
                        result = '安全范围';
                        desc = `第${count}枚: R=${effectiveR}正常生效`;
                        status = 'result-safe';
                        break;
                        
                    case count === 4:
                        let rValue = 30;
                        
                        if (cycleCount >= 5) {
                            rValue = 0;
                            result = '循环阻断 - R=0';
                            desc = '30日内第4枚达到5次，R=0且精神永久锁定[崩溃]边缘';
                            status = 'result-danger';
                        } else if (cycleCount >= 3) {
                            rValue = 15;
                            result = '循环衰减 - R减半';
                            desc = `30日内第4枚达到3次，R=${rValue}`;
                            status = 'result-warn';
                        } else {
                            result = '高风险高回报';
                            desc = `第4枚: R=${rValue}作用于躯体，精神强制跌落一阶`;
                        }
                        
                        if (stateIdx < 2) {
                            const next = states[stateIdx + 1];
                            desc += `\n${current} → ${next}`;
                            if (rValue > 0) {
                                const bodyBoost = Math.floor(rValue / 10);
                                desc += `\n躯体恢复: 每10R提升1阶状态 (+${bodyBoost}阶)`;
                            }
                        } else {
                            desc += '\n⚠ 精神已达崩溃，R将失效!';
                        }
                        
                        status = stateIdx >= 2 ? 'result-danger' : status || 'result-warn';
                        effectiveR = rValue;
                        break;
                        
                    case count === 5:
                        result = '纯惩罚';
                        effectiveR = 0;
                        desc = 'R=0，精神强制跌落，无收益';
                        status = 'result-danger';
                        break;
                        
                    default:
                        result = '剧毒 - 致死风险';
                        effectiveR = 0;
                        const deltaPenalty = (count - 5) * 20;
                        desc = `R=${effectiveR}, ΔEntropy+${deltaPenalty}, 躯体跌落两阶`;
                        
                        if (count >= 6) {
                            desc += '\n⚠ 濒死状态下吞噬 → [剧毒过载] → 直接死亡!';
                        }
                        status = 'result-danger';
                }

                this.updateResult(this.els.etherRes, result, desc, status);
            },
            calcFatigue() {
                const micro = parseInt(this.els.microFatigue?.value) || 0;
                const macro = parseInt(this.els.macroFatigue?.value) || 0;
                const reset = this.els.sleepReset?.value;
                const I_base = parseInt(this.els.actionI?.value) || 5;
                const E_base = parseFloat(this.els.envE?.value) || 1;

                let I_modified = I_base;
                let E_modified = E_base;
                let result = '正常', desc = '无疲劳累积', status = 'result-safe';

                if (reset === 'poor') {
                    result = '微观重置';
                    desc = '劣质睡眠: 仅重置微观计数器,宏观无效';
                    status = 'result-warn';
                } else if (reset === 'quality' || reset === 'long') {
                    result = '完全重置';
                    desc = reset === 'long' 
                        ? '长休: 重置微观+宏观计数器' 
                        : '优质睡眠: 重置微观计数器';
                    status = 'result-safe';
                } else {
                    if (micro >= 3 && I_base >= 15) {
                        I_modified = I_base * 2;
                        result = '微观疲劳';
                        desc = `连续${micro}轮I≥15, I=${I_base}→${I_modified}`;
                        status = 'result-danger';
                        
                        if (micro >= 6) {
                            desc += '\n⚠ 强行维持6轮+,状态上限锁定至长休';
                        }
                    }
                    
                    if (macro >= 3) {
                        E_modified += 0.3;
                        result = (micro >= 3 && I_base >= 15) ? '双重疲劳' : '宏观疲劳';
                        desc += `\n连续${macro}轮未长休, E=${(E_modified - 0.3).toFixed(1)}→${E_modified.toFixed(1)}`;
                        status = 'result-danger';
                    }
                    
                    if (micro >= 3 || macro >= 3) {
                        const delta = I_modified * E_modified;
                        desc += `\n实际ΔEntropy: ${delta.toFixed(1)} (I=${I_modified}, E=${E_modified.toFixed(1)})`;
                    }
                }

                this.updateResult(this.els.fatigueRes, result, desc, status);
            },
            calcDebt() {
                const days = parseInt(this.els.debtDays?.value) || 0;
                const repay = parseInt(this.els.debtRepay?.value) || 0;
                const status = this.els.debtStatus?.value;

                let result, desc, cls;

                if (days === 0) {
                    result = '无负债';
                    desc = '未持有因果负债';
                    cls = 'result-safe';
                } else {
                    const daysLeft = 30 - days;
                    if (daysLeft <= 0) {
                        result = '因果反噬';
                        desc = '30日未偿还，每日状态各跌一阶';
                        cls = 'result-danger';
                    } else if (daysLeft <= 5) {
                        result = `临界 (${daysLeft}天)`;
                        desc = `即将触发反噬 | 已偿还${repay}次 (≥5R值/次重置)`;
                        cls = 'result-danger';
                    } else {
                        result = `负债中 (${daysLeft}天)`;
                        desc = `有效偿还: 治疗他人/NPC、净化公共区域 | 已偿还${repay}次`;
                        cls = 'result-warn';
                    }
                }

                this.updateResult(this.els.debtRes, result, desc, cls);
            },
            calcCausal() {
                const base = parseInt(this.els.causalRange?.value) || 0;
                const souls = parseInt(this.els.soulCount?.value) || 0;
                const days = parseInt(this.els.noEntropyDays?.value) || 0;
                const equipBonus = parseInt(this.els.causalEquip?.value) || 0;

                const totalBase = base + equipBonus;
                
                if (this.els.causalVal) this.els.causalVal.textContent = totalBase;

                const levels = [
                    { n: '几乎没有', l: 5 },
                    { n: '偏低', l: 20 },
                    { n: '低', l: 40 },
                    { n: '偏中', l: 60 },
                    { n: '中', l: 80 },
                    { n: '偏高', l: 95 },
                    { n: '高', l: 100 }
                ];
                const level = levels.find(l => totalBase <= l.l) || levels[6];
                if (this.els.causalName) this.els.causalName.textContent = level.n;

                const dropLevels = Math.floor(days / 3);
                let finalLevel = Math.max(0, levels.indexOf(level) - dropLevels);

                const descriptions = [
                    '因果蒸发。无物理反馈，行为不计入因果账本。',
                    '微弱采样。极偶尔产生被注视的物理直觉。',
                    '特征提取。环境产生微妙的秩序感。',
                    '因果锚定。异象初现，无常判定产生聚簇。',
                    '现实收敛。感官扭曲，区域临界值加速累积。',
                    '法则锁定。凡人避让，高阶魔物精准锁定。',
                    '因果奇点。绝对干预权激活，伴随逻辑回弹风险。'
                ];

                let desc = descriptions[finalLevel];
                if (souls > 0) desc += `\n持有${souls}枚灵魂刻，暴露度+${souls * 5}。`;
                if (equipBonus > 0) desc += `\n装备加成: +${equipBonus}。`;
                if (dropLevels > 0) desc += `\n⚠ 熵增淡化：${days}日无负熵，跌落${dropLevels}级。`;

                const status = finalLevel >= 5 ? 'result-danger' : (finalLevel >= 3 ? 'result-warn' : 'result-safe');
                this.updateResult(this.els.causalRes, levels[finalLevel].n, desc, status);
            },
            calcSleep() {
                const isQuality = this.els.sleepType?.value === 'quality';
                const E = parseFloat(this.els.sleepE?.value) || 1;
                const hasDrain = this.els.soulDrain?.value === 'yes';
                const count = parseInt(this.els.sleepCount?.value) || 1;
                const weather = this.els.sleepWeather?.value || 'normal';
                const currentLoad = parseInt(this.els.currentLoad?.value) || 0;

                let R, result, desc, status;

                if (weather === 'marea') {
                    result = '无法优质睡眠';
                    desc = '魔潮前兆天气期间，强制劣质睡眠\nR=3~5，仅重置微观疲劳';
                    status = 'result-danger';
                    this.updateResult(this.els.sleepRes, result, desc, status);
                    return;
                }

                if (E > 0.5) {
                    R = 3 + Math.floor(Math.random() * 3);
                    result = `劣质睡眠 R=${R}`;
                    desc = `消除${R}点损耗，仅重置微观疲劳\n同日第二次无效，清醒<4小时强制劣质`;
                    status = 'result-warn';
                } else if (hasDrain) {
                    R = 8 + Math.floor(Math.random() * 3);
                    result = `R = ${R}`;
                    desc = '[灵魂耗竭]锁定：R降至8~10，仅清空槽值，状态阶级保持不变';
                    status = 'result-warn';
                } else {
                    if (count === 1) {
                        R = 15 + Math.floor(Math.random() * 6);
                    } else {
                        R = 8 + Math.floor(Math.random() * 3);
                    }
                    result = `优质睡眠 R = ${R}`;
                    
                    const canImprove = currentLoad > 0;
                    const stateImprovement = canImprove ? '提升1阶状态' : '状态已达最优';
                    desc = `清空槽值，${stateImprovement}${count === 2 ? ' (效果减半)' : ''}`;
                    
                    if (R > currentLoad + 10) {
                        const overflow = R - (currentLoad + 10);
                        desc += `\n溢出${overflow}点R值直接消散`;
                    }
                    
                    status = 'result-safe';
                }

                desc += '\n限制: 24h内仅1次优质有效，清醒<4h强制劣质';

                this.updateResult(this.els.sleepRes, result, desc, status);
            },
            calcLuck() {
                const count = parseInt(this.els.luckCount?.value) || 0;
                const streak = parseInt(this.els.luckStreak?.value) || 0;
                const env = this.els.luckEnv?.value || 'safe';

                const remaining = Math.max(0, 5 - count);
                const isSoftLocked = env === 'hazard';
                const critAccum = streak > 3 ? streak - 3 : 0;

                let result, desc, status;

                if (isSoftLocked) {
                    result = '软锁触发';
                    desc = '乱序区/积淤者存在时: 好运无法触发\n环境极度不稳定，无法抽取确定性';
                    status = 'result-danger';
                } else if (count >= 5) {
                    result = '达到上限';
                    desc = '单日5次上限，超限无效\n每日黎明06:00重置计数器';
                    status = 'result-warn';
                } else {
                    result = remaining > 0 ? `可触发 ${remaining}次` : '次数用尽';
                    desc = `今日已触发: ${count}/5次`;
                    if (critAccum > 0) {
                        desc += `\n⚠ 连续好运${streak}次: 临界值累积+${critAccum}`;
                        desc += '\n副作用: 周围人遭遇[概率补偿]倒霉';
                        status = 'result-warn';
                    } else {
                        status = 'result-safe';
                    }
                }

                this.updateResult(this.els.luckRes, result, desc, status);
            },
            calcLadder() {
                const exp = parseInt(this.els.ladderRank?.value) || 0;
                const E = parseFloat(this.els.ladderEnvE?.value) || 1;
                const I = parseInt(this.els.ladderActionI?.value) || 5;

                const E_final = E + (exp * 0.1);
                const delta = I * E_final;

                const rankNames = { 0: '无名之辈', 1: '榜上有名', 3: '天梯前百', 6: '天梯前十' };
                const rankName = rankNames[exp] || '未知';

                let result = `Δ = ${delta.toFixed(1)}`;
                let desc, status;

                const expPenalty = I * exp * 0.1;
                if (exp === 0) {
                    desc = `${rankName}: 基础熵增 = ${I * E}`;
                    status = 'result-safe';
                } else if (exp <= 3) {
                    desc = `${rankName}: E_final=${E_final.toFixed(2)}, 暴露惩罚+${expPenalty.toFixed(1)}熵增`;
                    status = delta > 20 ? 'result-danger' : 'result-warn';
                } else {
                    desc = `${rankName}: 行走的临界值磁铁! E_final=${E_final.toFixed(2)}\n暴露惩罚+${expPenalty.toFixed(1)}, 魔潮强度×${(1 + exp * 0.15).toFixed(2)}`;
                    status = delta >= 20 ? 'result-danger' : (delta >= 10 ? 'result-warn' : 'result-safe');
                }

                if (delta >= 20) {
                    desc += '\n⚠ 高熵增警告: 可能跌落两阶!';
                }

                this.updateResult(this.els.ladderRes, result, desc, status);
            },
            calcCrystal() {
                const count = parseInt(this.els.crystalCount?.value) || 0;
                const mentalIdx = parseInt(this.els.crystalMental?.value) || 0;
                const bodyIdx = parseInt(this.els.crystalBody?.value) || 2;
                const cycleCount = parseInt(this.els.crystalCycle?.value) || 0;
                const hasDrain = this.els.crystalDrain?.value === 'yes';

                const mentalStates = ['清醒', '动摇', '崩溃', '昏乱'];
                const bodyStates = ['充沛', '正常', '疲劳', '虚弱', '濒死'];
                const currentMental = mentalStates[mentalIdx];
                const currentBody = bodyStates[bodyIdx];

                let result, desc, status;

                if (mentalIdx >= 3) {
                    result = '无法吞噬';
                    desc = '昏乱状态下无法行动，更无法吞噬魔晶';
                    status = 'result-danger';
                } else if (count <= 3) {
                    const rValue = hasDrain && count === 3 ? '8-10' : '10';
                    result = `安全第${count + 1}枚`;
                    desc = `第${count + 1}枚魔晶: R=${rValue}正常生效`;
                    desc += `\n当前精神: ${currentMental} | 躯体: ${currentBody}`;
                    status = 'result-safe';
                } else if (count === 4) {
                    let rValue = hasDrain ? '8-10' : '30';
                    
                    if (cycleCount >= 5) {
                        rValue = '0';
                        result = '循环阻断!';
                        desc = '30日内第4枚达到5次，R=0且精神永久锁定[崩溃]边缘';
                    } else if (cycleCount >= 3) {
                        rValue = hasDrain ? '4-5' : '15';
                        result = '循环衰减';
                        desc = `30日内第4枚达到3次，R=${rValue}`;
                    } else {
                        result = '高风险高回报';
                        desc = `第4枚: 精神强制跌落一阶`;
                    }
                    
                    const nextMental = mentalStates[Math.min(mentalIdx + 1, 3)];
                    desc += `\n${currentMental} → ${nextMental}`;
                    
                    if (!hasDrain && cycleCount < 5) {
                        const bodyBoost = Math.floor(30 / 10);
                        desc += `\n躯体恢复: 每10R提升1阶 (+${bodyBoost}阶)`;
                    }
                    
                    status = mentalIdx >= 2 || cycleCount >= 5 ? 'result-danger' : 'result-warn';
                } else if (count === 5) {
                    const nextMental = mentalStates[Math.min(mentalIdx + 1, 3)];
                    result = '纯惩罚';
                    desc = `第5枚: R=0，精神强制跌落`;
                    desc += `\n${currentMental} → ${nextMental}`;
                    desc += '\n⚠ 无任何收益，纯惩罚!';
                    status = 'result-danger';
                } else {
                    const bodyDrop = Math.min(2, bodyIdx + 2);
                    const finalBody = bodyStates[Math.min(bodyIdx + 2, 4)];
                    result = '致命毒性';
                    desc = `第${count}枚: R=0, Δ+20`;
                    desc += `\n躯体强制跌落两阶: ${currentBody} → ${finalBody}`;
                    if (bodyIdx >= 3) {
                        desc += '\n⚠ 濒死状态下槽满溢出 → 死亡!';
                    }
                    status = 'result-danger';
                }

                this.updateResult(this.els.crystalRes, result, desc, status);
            },
            calcWeather() {
                const baseE = parseFloat(this.els.weatherBaseE?.value) || 1;
                const weatherMod = parseFloat(this.els.weatherType?.value) || 0;
                const weatherName = this.els.weatherType?.selectedOptions[0]?.dataset.name || '晴朗';

                const finalE = baseE + weatherMod;

                let desc = `${weatherName}天气: `;
                switch (weatherName) {
                    case '晴朗':
                        desc += '无额外效果';
                        break;
                    case '暴雨':
                        desc += '视野-50%，火焰-30%，积淤者活跃度+50%';
                        break;
                    case '以太风暴':
                        desc += '施法I+5，精神槽+20%，晶化律法生成+30%';
                        break;
                    case '黑雾':
                        desc += '视野-70%，蚀骨者生成+50%，秩序区效果-30%';
                        break;
                    case '魔潮前兆':
                        desc += '魔物生成+100%，高阶魔物出现，无法优质睡眠';
                        break;
                }

                const status = weatherMod >= 1.0 ? 'result-danger' : (weatherMod > 0 ? 'result-warn' : 'result-safe');
                this.updateResult(this.els.weatherRes, `E_final = ${finalE.toFixed(1)}`, desc, status);
            },
            calcFaction() {
                const rep = parseInt(this.els.factionRep?.value) || 0;
                const faction = this.els.factionSelect?.value || 'iron';

                if (this.els.factionRepVal) {
                    this.els.factionRepVal.textContent = rep;
                }

                const factionNames = {
                    iron: '铁冠王国',
                    mist: '雾谷帝国',
                    silver: '银湾联盟',
                    shadow: '灰影议会'
                };

                let result, desc, status;

                if (rep <= -50) {
                    result = '敌对';
                    desc = `${factionNames[faction]}视你为敌人\nNPC会攻击或拒绝服务，进入领土被攻击`;
                    status = 'result-danger';
                } else if (rep < 0) {
                    result = '冷淡';
                    desc = `${factionNames[faction]}对你态度冷漠\n价格+50%`;
                    status = 'result-warn';
                } else if (rep < 30) {
                    result = '中立';
                    desc = `${factionNames[faction]}对你保持中立\n正常交易`;
                    status = 'result-safe';
                } else if (rep < 70) {
                    result = '友好';
                    desc = `${factionNames[faction]}对你态度友好\n价格-20%，提供额外信息`;
                    status = 'result-safe';
                } else {
                    result = '崇敬';
                    desc = `${factionNames[faction]}对你充满敬意\n特殊任务，势力装备折扣`;
                    status = 'result-legendary';
                }

                this.updateResult(this.els.factionRes, result, desc, status);
            },
            updateResult(el, val, desc, cls) {
                if (!el) return;
                el.className = `result ${cls}`;
                el.innerHTML = `<div class="val">${val}</div><div class="desc">${desc.replace(/\n/g, '<br>')}</div>`;
            },
            loadRules() {
                const full = document.getElementById('fullPrompt')?.textContent || '';
                if (this.els.ruleDisplay) this.els.ruleDisplay.textContent = full.trim();
            },
            copy() {
                const text = document.getElementById('fullPrompt')?.textContent || '';
                if (!text) return;

                if (navigator.clipboard?.writeText) {
                    navigator.clipboard.writeText(text).then(() => this.showCopyOk());
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.cssText = 'position:fixed;opacity:0';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    this.showCopyOk();
                }
            },
            showCopyOk() {
                const btn = document.querySelector('button[onclick="App.copy()"]');
                if (!btn) return;
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                btn.style.background = 'var(--safe)';
                btn.style.color = '#000';
                setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
            },
            download() {
                const text = document.getElementById('fullPrompt')?.textContent || '';
                if (!text) return;

                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Aetherion_核心法则协议_V7.md';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>
